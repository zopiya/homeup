# ==============================================================================
# Lefthook Configuration - Git Hooks for Homeup
# ==============================================================================
# Install: lefthook install
# ==============================================================================

# Reduce output noise
skip_output:
  - meta
  - summary

# ------------------------------------------------------------------------------
# Pre-commit: Fast checks before commit
# ------------------------------------------------------------------------------
pre-commit:
  parallel: true
  commands:
    # Lint shell scripts
    shellcheck:
      glob: "*.sh"
      run: shellcheck {staged_files}

    # Validate templates
    template-check:
      glob: "*.tmpl"
      run: |
        for file in {staged_files}; do
          if ! chezmoi execute-template < "$file" > /dev/null 2>&1; then
            echo "✗ Template syntax error: $file"
            exit 1
          fi
        done

    # Prevent secrets in non-template files
    no-secrets:
      run: |
        for file in {staged_files}; do
          # Skip templates and example files
          [[ "$file" =~ \.(tmpl|example)$ ]] && continue

          if grep -qiE "(password|secret|token|api[_-]?key)\s*=" "$file" 2>/dev/null; then
            echo "✗ Potential secret found: $file"
            echo "  If this is intentional, use a template or .example file"
            exit 1
          fi
        done

# ------------------------------------------------------------------------------
# Commit-msg: Validate commit message format
# ------------------------------------------------------------------------------
commit-msg:
  commands:
    format-check:
      run: |
        msg=$(cat {1})

        # Check subject line length
        subject=$(echo "$msg" | head -n1)
        if [ ${#subject} -gt 72 ]; then
          echo "✗ Commit subject too long (${#subject} > 72 chars)"
          exit 1
        fi

        # Check for empty message
        if [ -z "$(echo "$msg" | grep -v '^#' | tr -d '[:space:]')" ]; then
          echo "✗ Empty commit message"
          exit 1
        fi

# ------------------------------------------------------------------------------
# Pre-push: Comprehensive checks before push
# ------------------------------------------------------------------------------
pre-push:
  parallel: true
  commands:
    # Validate all templates
    validate-templates:
      run: |
        echo "Validating templates..."
        for profile in macos linux; do
          export HOMEUP_PROFILE=$profile
          if ! chezmoi init --source . --destination /tmp/chezmoi-validate-$profile --dry-run 2>/dev/null; then
            echo "✗ Template validation failed for profile: $profile"
            exit 1
          fi
        done
        echo "✓ All templates valid"

    # Lint all shell scripts
    lint-all:
      run: |
        if ! command -v shellcheck &>/dev/null; then
          echo "⚠ shellcheck not installed, skipping"
          exit 0
        fi
        echo "Linting shell scripts..."
        find . -name "*.sh" -type f ! -path "./.git/*" -exec shellcheck {} \;
        echo "✓ Lint passed"
