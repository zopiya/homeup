# ==============================================================================
# Quality Tests
# ==============================================================================
# Code quality, linting, and validation tests
# ==============================================================================

name: Quality

on:
  workflow_call:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Lint shell scripts
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          echo "=== Linting Shell Scripts ==="
          find . -name "*.sh" -type f ! -path "./.git/*" | while read -r file; do
            echo "Checking $file..."
            shellcheck "$file"
          done
          echo "✓ All scripts passed"

      - name: Verify environment variables
        run: |
          echo "=== Testing Configurable Parameters ==="

          # Test that env vars are properly read
          export HOMEUP_CONNECTIVITY_TIMEOUT=15
          export HOMEUP_DOWNLOAD_TIMEOUT=180
          export HOMEUP_RETRY_COUNT=5
          export HOMEUP_RETRY_DELAY=10

          # Extract constants from bootstrap.sh
          if grep -q "HOMEUP_CONNECTIVITY_TIMEOUT" bootstrap.sh; then
            echo "✓ HOMEUP_CONNECTIVITY_TIMEOUT configurable"
          fi

          if grep -q "HOMEUP_DOWNLOAD_TIMEOUT" bootstrap.sh; then
            echo "✓ HOMEUP_DOWNLOAD_TIMEOUT configurable"
          fi

          if grep -q "HOMEUP_RETRY_COUNT" bootstrap.sh; then
            echo "✓ HOMEUP_RETRY_COUNT configurable"
          fi

          if grep -q "HOMEUP_RETRY_DELAY" bootstrap.sh; then
            echo "✓ HOMEUP_RETRY_DELAY configurable"
          fi

          echo "✓ All environment variables configurable"

  # Validate templates
  validate:
    name: Validate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install chezmoi
        run: sudo snap install chezmoi --classic

      - name: Validate templates
        run: |
          echo "=== Validating Templates ==="
          for profile in macos mini linux; do
            echo "Testing $profile..."
            export HOMEUP_PROFILE=$profile
            chezmoi init --source . --destination /tmp/test-$profile --dry-run
          done
          echo "✓ All templates valid"

  # Test justfile
  justfile:
    name: Justfile
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install just
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

      - name: Validate justfile syntax
        run: |
          echo "=== Validating Justfile ==="
          just --list > /dev/null
          echo "✓ Justfile syntax valid"

      - name: Install test dependencies
        run: |
          sudo apt-get install -y shellcheck
          sudo snap install chezmoi --classic

      - name: Test justfile commands
        run: |
          echo "=== Testing Justfile Commands ==="

          # Test validation commands
          echo "Testing validation..."
          just validate

          # Test lint
          echo "Testing lint..."
          just lint

          # Verify help works
          echo "Testing help..."
          just help

          echo "✓ All commands work"

  # Package validation
  packages:
    name: Packages
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH

      - name: Install just
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install just

      - name: Update Homebrew
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew update

      - name: Validate packages
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "=== Validating Packages ==="
          just pkg-validate
          echo "✓ All packages valid"

      - name: Check duplicates
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "=== Checking Duplicates ==="
          just pkg-duplicates
          echo "✓ No duplicates found"

  # Security configuration validation
  security:
    name: Security Config
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate GPG configuration
        run: |
          echo "=== Validating GPG Configuration ==="

          gpg_conf="private_dot_gnupg/gpg.conf"

          # Check modern security settings exist
          if grep -q "s2k-count 65011712" "$gpg_conf"; then
            echo "✓ Strong key derivation (s2k-count)"
          else
            echo "✗ Missing strong s2k-count"
            exit 1
          fi

          if grep -q "throw-keyids" "$gpg_conf"; then
            echo "✓ Privacy protection (throw-keyids)"
          else
            echo "✗ Missing throw-keyids"
            exit 1
          fi

          if grep -q "auto-key-retrieve" "$gpg_conf"; then
            echo "✓ Auto key retrieval enabled"
          else
            echo "✗ Missing auto-key-retrieve"
            exit 1
          fi

          if grep -q "hkps://keys.openpgp.org" "$gpg_conf"; then
            echo "✓ Modern keyserver configured"
          else
            echo "✗ Missing modern keyserver"
            exit 1
          fi

          if grep -q "trust-model tofu+pgp" "$gpg_conf"; then
            echo "✓ TOFU+PGP trust model"
          else
            echo "✗ Missing TOFU+PGP trust"
            exit 1
          fi

          echo "✓ All GPG hardening checks passed"
