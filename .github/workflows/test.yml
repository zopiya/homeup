name: Test Dotfiles

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/test.yml"

jobs:
  test-macos:
    name: Test on macOS (Workstation)
    runs-on: macos-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Bash 5
        run: |
          brew install bash
          echo "/usr/local/bin/bash" >> $GITHUB_PATH
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH

      - name: Check Bash version
        run: |
          which bash
          bash --version

      - name: Run bootstrap.sh
        run: |
          chmod +x bootstrap.sh
          bash ./bootstrap.sh
        env:
          CI: true
          NONINTERACTIVE: 1

      - name: Verify Installation
        run: |
          # Source the shellenv to verify environment variables are set correctly
          if [ -f "$HOME/.config/homebrew/shellenv" ]; then
            source "$HOME/.config/homebrew/shellenv"
          else
            echo "Error: shellenv file not found!"
            exit 1
          fi

          echo "Verifying Homebrew..."
          if ! command -v brew &> /dev/null; then
             echo "Error: brew command not found in PATH"
             exit 1
          fi
          brew --version

          echo "Verifying chezmoi..."
          if ! command -v chezmoi &> /dev/null; then
             echo "Error: chezmoi command not found in PATH"
             exit 1
          fi
          chezmoi --version

      - name: Initialize chezmoi
        run: |
          if [ -f "$HOME/.config/homebrew/shellenv" ]; then
            source "$HOME/.config/homebrew/shellenv"
          fi
          chezmoi init --apply --source .
        env:
          CHEZMOI_GIT_NAME: "Test User"
          CHEZMOI_GIT_EMAIL: "test@example.com"
          CHEZMOI_PROFILE: "1"
          CHEZMOI_INSTALL_SECURITY: "false"

      - name: Verify Dotfiles
        run: |
          echo "Verifying dotfiles installation..."
          
          # Check if key config files exist
          [ -f "$HOME/.config/starship.toml" ] || { echo "Error: starship.toml missing"; exit 1; }
          [ -f "$HOME/.config/zsh/.zshrc" ] || { echo "Error: .zshrc missing"; exit 1; }
          
          # Check if tools are in PATH
          export PATH="$HOME/.local/bin:$PATH"
          if [ -f "$HOME/.config/homebrew/shellenv" ]; then
            source "$HOME/.config/homebrew/shellenv"
          fi
          
          command -v starship >/dev/null || { echo "Error: starship not found"; exit 1; }
          command -v mise >/dev/null || { echo "Error: mise not found"; exit 1; }
          command -v nvim >/dev/null || { echo "Error: nvim not found"; exit 1; }
          
          echo "Verification passed!"

  test-linux:
    name: Test on ${{ matrix.distro }} (${{ matrix.type }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          # Workstation Profile (1)
          - distro: fedora
            type: Workstation
            image: fedora:latest
            profile: "1"
            pre_install: dnf install -y sudo curl git file shadow-utils findutils

          # Server Profile (2)
          - distro: ubuntu
            type: Server
            image: ubuntu:latest
            profile: "2"
            pre_install: apt-get update && apt-get install -y sudo curl git file
          - distro: debian
            type: Server
            image: debian:latest
            profile: "2"
            pre_install: apt-get update && apt-get install -y sudo curl git file

    container:
      image: ${{ matrix.image }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Container Environment
        run: |
          ${{ matrix.pre_install }}
          # Ensure zsh is installed for the verification step
          if command -v apt-get &> /dev/null; then
            apt-get install -y zsh
          elif command -v dnf &> /dev/null; then
            dnf install -y zsh
          fi
          
          useradd -m -s /bin/bash testuser
          echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
          chown -R testuser:testuser $GITHUB_WORKSPACE

      - name: Run bootstrap.sh
        run: |
          chmod +x bootstrap.sh
          # Pass CI and NONINTERACTIVE env vars to the user shell
          su - testuser -c "export CI=true NONINTERACTIVE=1 && cd $GITHUB_WORKSPACE && ./bootstrap.sh"
        env:
          CI: true
          NONINTERACTIVE: 1

      - name: Verify Installation
        run: |
          su - testuser -c "
            export CI=true
            # Simulate a new login shell or sourcing the env file
            if [ -f \"\$HOME/.config/homebrew/shellenv\" ]; then
              source \"\$HOME/.config/homebrew/shellenv\"
            else
              echo 'Error: shellenv file not found!'
              exit 1
            fi
            
            echo 'Verifying Homebrew...'
            if ! command -v brew &> /dev/null; then
               echo 'Error: brew command not found in PATH'
               exit 1
            fi
            brew --version
            
            echo 'Verifying chezmoi...'
            if ! command -v chezmoi &> /dev/null; then
               echo 'Error: chezmoi command not found in PATH'
               exit 1
            fi
            chezmoi --version
          "

      - name: Initialize chezmoi
        run: |
          su - testuser -c "
            export CI=true
            export CHEZMOI_GIT_NAME='Test User'
            export CHEZMOI_GIT_EMAIL='test@example.com'
            export CHEZMOI_PROFILE='${{ matrix.profile }}'
            export CHEZMOI_INSTALL_SECURITY='false'
            
            if [ -f \"\$HOME/.config/homebrew/shellenv\" ]; then
              source \"\$HOME/.config/homebrew/shellenv\"
            fi
            
            cd $GITHUB_WORKSPACE
            chezmoi init --apply --source .
          "

      - name: Verify Dotfiles
        run: |
          su - testuser -c "
            export CI=true
            echo 'Verifying dotfiles installation...'
            
            # Check if key config files exist
            [ -f \"\$HOME/.config/starship.toml\" ] || { echo 'Error: starship.toml missing'; exit 1; }
            
            # .zshrc might be in .config/zsh/.zshrc or ~/.zshrc depending on ZDOTDIR
            if [ -f \"\$HOME/.config/zsh/.zshrc\" ]; then
                echo 'Found .zshrc in .config/zsh'
            elif [ -f \"\$HOME/.zshrc\" ]; then
                echo 'Found .zshrc in HOME'
            else
                echo 'Error: .zshrc missing'
                exit 1
            fi
            
            # Check if tools are in PATH (via .local/bin)
            export PATH=\"\$HOME/.local/bin:\$PATH\"
            if [ -f \"\$HOME/.config/homebrew/shellenv\" ]; then
              source \"\$HOME/.config/homebrew/shellenv\"
            fi
            
            # Core checks (Profile 1 & 2)
            command -v starship >/dev/null || { echo 'Error: starship not found'; exit 1; }
            command -v mise >/dev/null || { echo 'Error: mise not found'; exit 1; }
            command -v nvim >/dev/null || { echo 'Error: nvim not found'; exit 1; }
            
            echo 'Verification passed!'
          "
