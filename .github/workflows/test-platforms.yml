# ==============================================================================
# Platform Tests
# ==============================================================================
# Tests bootstrap.sh and profile configurations across supported platforms
#
# Matrix:
#   - macOS (macos profile)
#   - Debian (mini, linux profiles)
#   - Fedora (mini, linux profiles)
# ==============================================================================

name: Platforms

on:
  workflow_call:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NONINTERACTIVE: 1
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_ANALYTICS: 1
  CI: true

jobs:
  # macOS + macos profile
  macos:
    name: macOS / macos
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Bash 5+
        run: |
          brew install bash
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            ~/.config/homebrew
          key: macos-homebrew-${{ hashFiles('bootstrap.sh') }}
          restore-keys: macos-homebrew-

      - name: Bootstrap
        run: |
          chmod +x bootstrap.sh
          ./bootstrap.sh -p macos -y
        env:
          HOMEUP_PROFILE: macos

      - name: Apply dotfiles
        run: |
          source "$HOME/.config/homebrew/shellenv"
          chezmoi init --apply --source .
        env:
          HOMEUP_PROFILE: macos

      - name: Install just
        run: |
          source "$HOME/.config/homebrew/shellenv"
          brew install just

      - name: Verify installation
        run: |
          source "$HOME/.config/homebrew/shellenv"
          export PATH="$HOME/.local/bin:$PATH"

          echo "=== Verifying macOS Profile ==="

          # Check core files
          test -f "$HOME/.config/starship.toml" || exit 1
          test -f "$HOME/.config/zsh/.zshrc" || exit 1
          test -f "$HOME/.ssh/config" || exit 1
          test -f "$HOME/.gnupg/gpg.conf" || exit 1

          # Check tools
          command -v zsh || exit 1
          command -v starship || exit 1
          command -v nvim || exit 1
          command -v fzf || exit 1

          # macOS-specific: GPG signing
          grep -q "gpgsign = true" "$HOME/.config/git/config" || exit 1

          echo "✓ Verification passed"

      - name: Run health check
        run: |
          source "$HOME/.config/homebrew/shellenv"
          just doctor

  # Debian matrix
  debian:
    name: Debian / ${{ matrix.profile }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        profile: [mini, linux]

    container:
      image: debian:latest
      options: --user root

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y git sudo curl ca-certificates file procps

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: /home/linuxbrew/.linuxbrew
          key: debian-${{ matrix.profile }}-${{ hashFiles('bootstrap.sh') }}
          restore-keys: debian-${{ matrix.profile }}-

      - name: Setup test user
        run: |
          useradd -m -s /bin/bash testuser
          echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser
          chmod +x bootstrap.sh
          chown -R testuser:testuser $GITHUB_WORKSPACE

      - name: Bootstrap
        run: |
          sudo -u testuser bash -c "
            export HOMEUP_PROFILE=${{ matrix.profile }}
            cd $GITHUB_WORKSPACE
            ./bootstrap.sh -p ${{ matrix.profile }} -y
          "

      - name: Apply dotfiles
        run: |
          sudo -u testuser bash -c "
            export HOMEUP_PROFILE=${{ matrix.profile }}
            eval \"\$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)\"
            cd $GITHUB_WORKSPACE
            chezmoi init --apply --source .
          "

      - name: Install just
        run: |
          sudo -u testuser bash -c '
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            brew install just
          '

      - name: Verify core
        run: |
          sudo -u testuser bash -c '
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            export PATH="$HOME/.local/bin:$PATH"

            echo "=== Verifying Core ==="

            # Config files
            test -f "$HOME/.config/starship.toml" || exit 1
            test -f "$HOME/.config/zsh/.zshrc" || test -f "$HOME/.zshrc" || exit 1

            # Core tools
            command -v zsh || exit 1
            command -v starship || exit 1
            command -v nvim || exit 1
            command -v fzf || exit 1

            echo "✓ Core verified"
          '

      - name: Verify profile-specific (mini)
        if: matrix.profile == 'mini'
        run: |
          sudo -u testuser bash -c '
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

            # GPG signing disabled
            grep -q "gpgsign = false" "$HOME/.config/git/config" || exit 1

            # SSH ForwardAgent disabled
            grep -q "ForwardAgent no" "$HOME/.ssh/config" || exit 1

            echo "✓ Mini profile verified"
          '

      - name: Verify profile-specific (linux)
        if: matrix.profile == 'linux'
        run: |
          sudo -u testuser bash -c '
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

            # GPG signing disabled
            grep -q "gpgsign = false" "$HOME/.config/git/config" || exit 1

            # Security configs excluded
            test ! -f "$HOME/.config/security/1password.inc" || exit 1
            test ! -f "$HOME/.config/security/yubikey.inc" || exit 1

            echo "✓ Linux profile verified"
          '

      - name: Run health check
        run: |
          sudo -u testuser bash -c '
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            just doctor
          '

  # Fedora matrix
  fedora:
    name: Fedora / ${{ matrix.profile }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        profile: [mini, linux]

    container:
      image: fedora:latest
      options: --user root

    steps:
      - name: Install dependencies
        run: |
          dnf install -y git sudo curl which tar gzip procps-ng hostname findutils

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: /home/linuxbrew/.linuxbrew
          key: fedora-${{ matrix.profile }}-${{ hashFiles('bootstrap.sh') }}
          restore-keys: fedora-${{ matrix.profile }}-

      - name: Setup test user
        run: |
          useradd -m -s /bin/bash testuser
          echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser
          chmod +x bootstrap.sh
          chown -R testuser:testuser $GITHUB_WORKSPACE

      - name: Bootstrap
        run: |
          sudo -u testuser bash -c "
            export HOMEUP_PROFILE=${{ matrix.profile }}
            cd $GITHUB_WORKSPACE
            ./bootstrap.sh -p ${{ matrix.profile }} -y
          "

      - name: Apply dotfiles
        run: |
          sudo -u testuser bash -c "
            export HOMEUP_PROFILE=${{ matrix.profile }}
            eval \"\$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)\"
            cd $GITHUB_WORKSPACE
            chezmoi init --apply --source .
          "

      - name: Install just
        run: |
          sudo -u testuser bash -c '
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            brew install just
          '

      - name: Verify core
        run: |
          sudo -u testuser bash -c '
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            export PATH="$HOME/.local/bin:$PATH"

            echo "=== Verifying Core ==="

            # Config files
            test -f "$HOME/.config/starship.toml" || exit 1
            test -f "$HOME/.config/zsh/.zshrc" || test -f "$HOME/.zshrc" || exit 1

            # Core tools
            command -v zsh || exit 1
            command -v starship || exit 1
            command -v nvim || exit 1
            command -v fzf || exit 1

            echo "✓ Core verified"
          '

      - name: Verify profile-specific (mini)
        if: matrix.profile == 'mini'
        run: |
          sudo -u testuser bash -c '
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

            # GPG signing disabled
            grep -q "gpgsign = false" "$HOME/.config/git/config" || exit 1

            # SSH ForwardAgent disabled
            grep -q "ForwardAgent no" "$HOME/.ssh/config" || exit 1

            echo "✓ Mini profile verified"
          '

      - name: Verify profile-specific (linux)
        if: matrix.profile == 'linux'
        run: |
          sudo -u testuser bash -c '
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

            # GPG signing disabled
            grep -q "gpgsign = false" "$HOME/.config/git/config" || exit 1

            # Security configs excluded
            test ! -f "$HOME/.config/security/1password.inc" || exit 1
            test ! -f "$HOME/.config/security/yubikey.inc" || exit 1

            echo "✓ Linux profile verified"
          '

      - name: Run health check
        run: |
          sudo -u testuser bash -c '
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            just doctor
          '
