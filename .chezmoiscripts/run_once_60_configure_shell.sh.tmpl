#!/usr/bin/env bash
#
# Description: Setup shell environment (FZF, Zsh, etc.)
# Author: GitHub Copilot
# Generated: 2025-12-16

set -euo pipefail

# --- Helper Functions ---
readonly GREEN='\033[1;32m'
readonly BLUE='\033[1;34m'
readonly YELLOW='\033[1;33m'
readonly RED='\033[1;31m'
readonly CYAN='\033[1;36m'
readonly GRAY='\033[0;90m'
readonly NC='\033[0m' # No Color

info() { echo -e "${BLUE}::${NC} $1"; }
success() { echo -e "${GREEN}>>${NC} $1"; }
error() { echo -e "${RED}!!${NC} $1"; }
warning() { echo -e "${YELLOW}!!${NC} $1"; }
substep() { echo -e "${GRAY}   -> $1${NC}"; }
step() { echo -e "${CYAN}[$1/$2]${NC} $3"; }
header() { echo ""; echo -e "${BLUE}==>${NC} ${1}"; echo ""; }
check_cmd() { command -v "$1" >/dev/null 2>&1; }
# ------------------------

header "Configuring Shell Environment"

# 1. Determine the target Zsh path
step 1 3 "Locating Zsh..."

TARGET_SHELL=""

# Try to find Homebrew zsh first
if check_cmd brew; then
    BREW_PREFIX=$(brew --prefix)
    if [ -x "$BREW_PREFIX/bin/zsh" ]; then
        TARGET_SHELL="$BREW_PREFIX/bin/zsh"
        substep "Found Homebrew Zsh: $TARGET_SHELL"
    fi
fi

# Fallback to system zsh if brew zsh not found
if [ -z "$TARGET_SHELL" ]; then
    TARGET_SHELL=$(command -v zsh)
    substep "Found System Zsh: $TARGET_SHELL"
fi

if [ -z "$TARGET_SHELL" ]; then
    error "Zsh not found. Please install zsh first."
    exit 1
fi

# 2. Ensure Zsh is in /etc/shells
step 2 3 "Verifying /etc/shells..."

if ! grep -q "$TARGET_SHELL" /etc/shells; then
    warning "Shell $TARGET_SHELL is not in /etc/shells"
    info "Adding it now..."
    if check_cmd sudo; then
        echo "$TARGET_SHELL" | sudo tee -a /etc/shells >/dev/null
    else
        echo "$TARGET_SHELL" | tee -a /etc/shells >/dev/null
    fi
    success "Added to /etc/shells"
else
    substep "Shell is already in /etc/shells"
fi

# 3. Change default shell
step 3 3 "Setting default shell..."

CURRENT_SHELL=$SHELL
# On macOS, $SHELL might not update immediately, so we check user database
if [ "$(uname)" == "Darwin" ]; then
    CURRENT_SHELL=$(dscl . -read /Users/$USER UserShell | awk '{print $2}')
elif [ "$(uname)" == "Linux" ]; then
    CURRENT_SHELL=$(getent passwd $USER | awk -F: '{print $7}')
fi

if [ "$CURRENT_SHELL" != "$TARGET_SHELL" ]; then
    info "Changing shell from $CURRENT_SHELL to $TARGET_SHELL"
    
    # Use sudo to change shell.
    # 1. In CI: Works without password (NOPASSWD configured).
    # 2. Local: Reuses cached sudo credentials from Step 2, avoiding a second password prompt.
    if check_cmd sudo; then
        sudo chsh -s "$TARGET_SHELL" "$USER"
    elif [ -n "${CI:-}" ]; then
        warning "CI detected and sudo not found. Skipping shell change to avoid password prompt hang."
    else
        chsh -s "$TARGET_SHELL"
    fi

    success "Default shell changed"
else
    substep "Default shell is already correct"
fi

# Install FZF key bindings
step 1 1 "Configuring FZF..."
FZF_INSTALL_SCRIPT="$(brew --prefix)/opt/fzf/install"

if [ -f "$FZF_INSTALL_SCRIPT" ]; then
    if [ -f "$HOME/.fzf.zsh" ]; then
        substep "FZF bindings already configured"
    else
        info "Running FZF install script..."
        "$FZF_INSTALL_SCRIPT" --all --no-bash --no-fish
        success "FZF bindings installed"
    fi
else
    warning "FZF install script not found, skipping..."
fi

success "Shell setup complete"
