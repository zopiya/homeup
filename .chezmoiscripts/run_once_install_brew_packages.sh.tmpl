#!/usr/bin/env bash
# ==============================================================================
# Homeup Installation Script
# ==============================================================================
# Purpose: Core installation logic (Brew, Runtimes, Shell, Security)
# Profile: {{ .profile | default "mini" }}
# ==============================================================================

set -Eeuo pipefail

# Profile configuration (from chezmoi)
readonly PROFILE="{{ .profile | default \"mini\" }}"

# ------------------------------------------------------------------------------
# Constants & Helpers
# ------------------------------------------------------------------------------

readonly SPINNER_FRAMES='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
readonly MISE_INSTALLER_URL="https://mise.run"

# TTY detection
if [[ -t 1 ]] && [[ "${TERM:-dumb}" != "dumb" ]]; then
    readonly IS_TTY=true
    readonly C_RESET=$'\033[0m'
    readonly C_GREEN=$'\033[32m'
    readonly C_RED=$'\033[31m'
    readonly C_CYAN=$'\033[36m'
    readonly C_BLUE=$'\033[34m'
    readonly C_YELLOW=$'\033[33m'
else
    readonly IS_TTY=false
    readonly C_RESET='' C_GREEN='' C_RED='' C_CYAN='' C_BLUE='' C_YELLOW=''
fi

msg_ok()   { printf "%s[OK]%s   %s\n" "$C_GREEN" "$C_RESET" "$1"; }
msg_skip() { printf "%s[SKIP]%s %s\n" "$C_YELLOW" "$C_RESET" "$1"; }
msg_fail() { printf "%s[FAIL]%s %s\n" "$C_RED" "$C_RESET" "$1" >&2; }
msg_info() { printf "%s[INFO]%s %s\n" "$C_BLUE" "$C_RESET" "$1"; }
header()   { printf "\n%s━━━ %s ━━━%s\n" "$C_CYAN" "$1" "$C_RESET"; }

die() {
    msg_fail "$1"
    exit "${2:-1}"
}

spinner() {
    local pid=$1
    local message=$2
    local frame=0
    local -r delay=0.1
    local exit_code

    if [[ "$IS_TTY" != true ]]; then
        printf "       %s...\n" "$message"
        wait "$pid" 2>/dev/null
        return $?
    fi

    # Ensure cursor is restored on exit
    trap 'printf "\033[?25h"' RETURN

    # Hide cursor
    printf "\033[?25l"

    while kill -0 "$pid" 2>/dev/null; do
        printf "\r\033[K%s%s%s %s" "$C_CYAN" "${SPINNER_FRAMES:frame:1}" "$C_RESET" "$message"
        frame=$(( (frame + 1) % ${#SPINNER_FRAMES} ))
        sleep "$delay"
    done

    # Clear line and restore cursor
    printf "\r\033[K"
    printf "\033[?25h"

    wait "$pid" 2>/dev/null
    exit_code=$?
    return "$exit_code"
}

require_cmd() {
    if ! command -v "$1" >/dev/null 2>&1; then
        die "Missing required command: $1"
    fi
}

# ------------------------------------------------------------------------------
# 1. Environment Initialization
# ------------------------------------------------------------------------------

find_homebrew() {
    local -r brew_paths=(
        /opt/homebrew/bin/brew
        /usr/local/bin/brew
        /home/linuxbrew/.linuxbrew/bin/brew
        "$HOME/.linuxbrew/bin/brew"
    )

    for brew_path in "${brew_paths[@]}"; do
        if [[ -x "$brew_path" ]]; then
            echo "$brew_path"
            return 0
        fi
    done
    return 1
}

init_environment() {
    header "Environment"

    # Find and load Homebrew
    local brew_bin
    if brew_bin=$(find_homebrew); then
        eval "$("$brew_bin" shellenv)"
        msg_ok "Homebrew found at $brew_bin"
    else
        die "Homebrew is not installed. Please run ./bootstrap.sh first."
    fi

    # Verify brew is in PATH
    if ! command -v brew >/dev/null 2>&1; then
        die "Homebrew found but not in PATH after shellenv"
    fi
}

# ------------------------------------------------------------------------------
# 2. Package Installation (Brewfile)
# ------------------------------------------------------------------------------
# Profile-based package installation:
#   - core: Essential CLI tools (macos and linux profiles)
#   - macos: Full toolset + GUI + security hardware
#   - mini: Standalone dev container setup (does NOT inherit core)
#   - linux: Headless server + workstation tools (no GUI)
# ------------------------------------------------------------------------------

install_packages() {
    header "Packages (Homebrew) [Profile: $PROFILE]"

    local -r source_dir="{{ .chezmoi.sourceDir }}"
    local brewfiles=()

    # Profile-specific package installation
    case "$PROFILE" in
        macos)
            # macOS: core + macos packages
            brewfiles+=("$source_dir/packages/Brewfile.core")
            brewfiles+=("$source_dir/packages/Brewfile.macos")
            ;;
        linux)
            # Linux: core + linux packages
            brewfiles+=("$source_dir/packages/Brewfile.core")
            brewfiles+=("$source_dir/packages/Brewfile.linux")
            ;;
        mini)
            # Mini is standalone - replace core, don't add to it
            brewfiles=("$source_dir/packages/Brewfile.mini")
            ;;
        *)
            msg_fail "Unknown profile: $PROFILE, falling back to core"
            brewfiles+=("$source_dir/packages/Brewfile.core")
            ;;
    esac

    # Install each Brewfile
    for brewfile in "${brewfiles[@]}"; do
        if [[ ! -f "$brewfile" ]]; then
            msg_skip "Brewfile not found: $(basename "$brewfile")"
            continue
        fi

        local brewfile_name
        brewfile_name="$(basename "$brewfile")"
        msg_info "Installing: $brewfile_name"

        # Run in background with output suppression
        (
            export HOMEBREW_NO_AUTO_UPDATE=1
            brew bundle --file="$brewfile" 2>&1 | grep -v "^Using " | grep -v "^Homebrew Bundle complete"
        ) >/dev/null 2>&1 &

        local bundle_pid=$!

        if spinner "$bundle_pid" "Processing $brewfile_name"; then
            msg_ok "$brewfile_name completed"
        else
            msg_fail "$brewfile_name failed. Retrying with verbose output..."
            # Retry with visible output for debugging
            export HOMEBREW_NO_AUTO_UPDATE=1
            if ! brew bundle --file="$brewfile"; then
                msg_fail "Failed to install $brewfile_name (continuing anyway)"
            fi
        fi
    done
}

# ------------------------------------------------------------------------------
# 3. Security Tools (GPG - macOS Only)
# ------------------------------------------------------------------------------

configure_security() {
    header "Security [Profile: $PROFILE]"

    if [[ "$PROFILE" != "macos" ]]; then
        msg_skip "GPG agent not needed for $PROFILE profile"
        return 0
    fi

    if ! command -v gpgconf >/dev/null 2>&1; then
        msg_skip "GPG not found"
        return 0
    fi

    # Restart GPG agent
    if gpgconf --kill gpg-agent 2>/dev/null; then
        sleep 1
        if gpgconf --launch gpg-agent 2>/dev/null; then
            msg_ok "GPG Agent reloaded"
        else
            msg_fail "Failed to launch GPG agent (continuing anyway)"
        fi
    else
        msg_skip "GPG agent not running"
    fi
}

# ------------------------------------------------------------------------------
# 4. Runtimes (Mise)
# ------------------------------------------------------------------------------

install_mise() {
    if command -v mise >/dev/null 2>&1; then
        return 0
    fi

    msg_info "Installing Mise..."

    # Download installer
    local -r mise_installer="/tmp/mise-install-$$.sh"
    if ! curl -fsSL "$MISE_INSTALLER_URL" -o "$mise_installer"; then
        rm -f "$mise_installer"
        return 1
    fi

    # Run installer
    if bash "$mise_installer" >/dev/null 2>&1; then
        rm -f "$mise_installer"
        export PATH="$HOME/.local/bin:$PATH"
        return 0
    else
        rm -f "$mise_installer"
        return 1
    fi
}

configure_runtimes() {
    header "Runtimes"

    # Install mise if needed
    if ! install_mise; then
        msg_fail "Failed to install Mise (continuing anyway)"
        return 0
    fi

    # Verify mise is available
    if ! command -v mise >/dev/null 2>&1; then
        msg_fail "Mise installed but not found in PATH"
        return 0
    fi

    # Configure mise and install runtimes in background
    (
        # Install configured runtimes
        mise install -y 2>&1 | grep -v "^mise " | head -20 || true

        # Set global runtimes
        mise use -g python@3.12 node@lts -y 2>&1 | grep -v "^mise " || true

        # Install Python tools
        if mise which python >/dev/null 2>&1; then
            if ! command -v uv >/dev/null 2>&1; then
                mise exec python@3.12 -- pip install -q uv 2>&1 | grep -v "^Requirement already satisfied" || true
            fi
        fi

        # Install Node tools
        if mise which node >/dev/null 2>&1; then
            if ! command -v pnpm >/dev/null 2>&1; then
                mise exec node@lts -- npm install -g pnpm --silent 2>&1 | head -10 || true
            fi
        fi
    ) >/dev/null 2>&1 &

    local mise_pid=$!

    if spinner "$mise_pid" "Configuring Mise & Global packages"; then
        msg_ok "Mise configured (Python 3.12, Node LTS, uv, pnpm)"
    else
        msg_fail "Mise configuration had errors (continuing anyway)"
    fi
}

# ------------------------------------------------------------------------------
# 5. Shell Configuration
# ------------------------------------------------------------------------------

has_sudo() {
    command -v sudo >/dev/null 2>&1 && sudo -n true 2>/dev/null
}

add_shell_to_etc_shells() {
    local shell_path=$1

    if grep -qx "$shell_path" /etc/shells 2>/dev/null; then
        return 0
    fi

    msg_info "Adding $shell_path to /etc/shells..."

    if has_sudo; then
        echo "$shell_path" | sudo tee -a /etc/shells >/dev/null
    elif [[ -w /etc/shells ]]; then
        echo "$shell_path" >> /etc/shells
    else
        msg_fail "Cannot modify /etc/shells (no sudo or write access)"
        return 1
    fi
}

get_current_shell() {
    if [[ "$(uname -s)" == "Darwin" ]]; then
        dscl . -read "/Users/$USER" UserShell 2>/dev/null | awk '{print $2}'
    else
        echo "$SHELL"
    fi
}

change_default_shell() {
    local target_shell=$1
    local current_shell
    current_shell=$(get_current_shell)

    if [[ "$current_shell" == "$target_shell" ]]; then
        msg_skip "Default shell is already $target_shell"
        return 0
    fi

    msg_info "Changing default shell to $target_shell..."

    if has_sudo; then
        if sudo chsh -s "$target_shell" "$USER" 2>/dev/null; then
            msg_ok "Shell changed to $target_shell"
            return 0
        fi
    elif chsh -s "$target_shell" 2>/dev/null; then
        msg_ok "Shell changed to $target_shell"
        return 0
    fi

    msg_fail "Failed to change shell (continuing anyway)"
    return 1
}

configure_shell() {
    header "Shell"

    # Find Zsh
    local target_shell=""
    local brew_prefix
    brew_prefix="$(brew --prefix 2>/dev/null)" || brew_prefix=""

    if [[ -n "$brew_prefix" ]] && [[ -x "$brew_prefix/bin/zsh" ]]; then
        target_shell="$brew_prefix/bin/zsh"
    elif command -v zsh >/dev/null 2>&1; then
        target_shell="$(command -v zsh)"
    else
        msg_fail "Zsh not found"
        return 1
    fi

    msg_info "Found Zsh at $target_shell"

    # Add to /etc/shells
    add_shell_to_etc_shells "$target_shell" || true

    # Change default shell
    change_default_shell "$target_shell" || true

    # FZF bindings
    if [[ -n "$brew_prefix" ]]; then
        local fzf_install="$brew_prefix/opt/fzf/install"
        if [[ -f "$fzf_install" ]]; then
            if [[ ! -f "$HOME/.fzf.zsh" ]]; then
                if "$fzf_install" --all --no-bash --no-fish >/dev/null 2>&1; then
                    msg_ok "FZF bindings installed"
                else
                    msg_skip "FZF bindings installation failed"
                fi
            else
                msg_skip "FZF bindings already present"
            fi
        fi
    fi
}

# ------------------------------------------------------------------------------
# Main
# ------------------------------------------------------------------------------

cleanup() {
    # Ensure cursor is visible on exit
    if [[ "$IS_TTY" == true ]]; then
        printf "\033[?25h"
    fi
}

main() {
    trap cleanup EXIT

    init_environment
    install_packages
    configure_security
    configure_runtimes
    configure_shell

    header "Complete"
    msg_ok "Configuration finished successfully."
    msg_info "Please restart your shell to apply all changes."
    printf "\n"
}

main "$@"
