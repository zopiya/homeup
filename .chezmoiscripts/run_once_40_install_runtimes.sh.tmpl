#!/usr/bin/env bash
#
# Description: Install and configure Mise (Runtime Manager)
# Author: GitHub Copilot
# Generated: 2025-12-16

set -euo pipefail

# --- Helper Functions ---
readonly GREEN='\033[1;32m'
readonly BLUE='\033[1;34m'
readonly YELLOW='\033[1;33m'
readonly RED='\033[1;31m'
readonly CYAN='\033[1;36m'
readonly GRAY='\033[0;90m'
readonly NC='\033[0m' # No Color

info() { echo -e "${BLUE}::${NC} $1"; }
success() { echo -e "${GREEN}>>${NC} $1"; }
error() { echo -e "${RED}!!${NC} $1"; }
warning() { echo -e "${YELLOW}!!${NC} $1"; }
substep() { echo -e "${GRAY}   -> $1${NC}"; }
step() { echo -e "${CYAN}[$1/$2]${NC} $3"; }
header() { echo ""; echo -e "${BLUE}==>${NC} ${1}"; echo ""; }
check_cmd() { command -v "$1" >/dev/null 2>&1; }
# ------------------------

{{ if not (get . "install_mise") -}}
info "Skipping Mise installation"
exit 0
{{ end -}}

header "Configuring Mise Runtime Manager"

# Disable Node.js signature verification in CI/Headless environments to avoid GPG errors
if [ -n "${CI:-}" ]; then
    warning "CI detected: Disabling Node.js GPG signature verification"
    export MISE_NODE_VERIFY_SIGNATURES=0
    export NODEJS_CHECK_SIGNATURES="no" # For asdf-nodejs compatibility
fi

# Homebrew Configuration
if [[ -x /opt/homebrew/bin/brew ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -x /usr/local/bin/brew ]]; then
  eval "$(/usr/local/bin/brew shellenv)"
elif [[ -x /home/linuxbrew/.linuxbrew/bin/brew ]]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
elif [[ -x "$HOME/.linuxbrew/bin/brew" ]]; then
  eval "$("$HOME/.linuxbrew/bin/brew" shellenv)"
fi

# Install Mise if not present
if ! check_cmd mise; then
    info "Installing Mise..."
    curl https://mise.run | sh
    export PATH="$HOME/.local/bin:$PATH"
else
    success "Mise is already installed"
fi

# Install tools defined in config.toml
step 1 3 "Installing tools from config.toml..."
if mise install; then
    success "Tools installed"
else
    error "Failed to install tools"
    exit 1
fi

# Install global packages
step 2 3 "Installing global packages..."

# Python
if ! mise list python | grep -q "3.12"; then
    info "Installing Python 3.12..."
    mise use -g python@3.12
else
    substep "Python 3.12 already installed"
fi

# Node
if ! mise list node | grep -q "lts"; then
    info "Installing Node.js LTS..."
    mise use -g node@lts
else
    substep "Node.js LTS already installed"
fi

success "Global packages installed"

# Install uv and pnpm
step 3 3 "Installing package managers..."

# uv
if ! check_cmd uv; then
    info "Installing uv..."
    mise exec python@3.12 -- pip install uv
else
    substep "uv already installed"
fi

# pnpm
if ! check_cmd pnpm; then
    info "Installing pnpm..."
    mise exec node@lts -- npm install -g pnpm
else
    substep "pnpm already installed"
fi

success "Mise configuration complete"
