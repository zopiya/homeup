{{- /* ==============================================================================
Git Configuration - Profile-Aware

Profile Matrix:
  - all: Default to SSH signing using YubiKey FIDO2 keys

Requirements:
  - Git 2.34+ (for SSH signing support)
  - OpenSSH 8.0+ (for ssh-keygen signing)
  - Delta (optional, for enhanced diffs)

Architecture:
  - Signing: SSH keys (YubiKey FIDO2) instead of GPG
  - Authentication: SSH for all Git forges (GitHub, GitLab, etc.)
  - Verification: ~/.ssh/allowed_signers for signature validation
============================================================================== */ -}}
{{- $profile := .profile | default "linux" -}}
{{- $isMacos := eq $profile "macos" -}}

# ==============================================================================
# Git Configuration
# Profile: {{ $profile }} | OS: {{ .chezmoi.os }}
# ==============================================================================

[include]
    # Load identity and aliases from separate files
    path = ~/.config/git/identity.gitconfig
    path = ~/.config/git/aliases.gitconfig

# ------------------------------------------------------------------------------
# Core Settings
# ------------------------------------------------------------------------------
[core]
    editor = nvim
    pager = delta

    # Line Endings: Convert CRLF to LF on commit, keep LF on checkout
    autocrlf = input
    safecrlf = true
    eol = lf

{{- if eq .chezmoi.os "darwin" }}
    # macOS Specific: Handle filename normalization (NFC vs NFD)
    precomposeunicode = true
    ignorecase = true
{{- end }}

# ------------------------------------------------------------------------------
# Network & Credentials
# ------------------------------------------------------------------------------
[credential]
{{- if eq .chezmoi.os "darwin" }}
    helper = osxkeychain
{{- else }}
    # Linux: Minimal cache for zero-trust hosts (servers, containers, Codespaces)
    helper = cache --timeout=60
{{- end }}

[protocol]
    # Use Git wire protocol v2 (faster fetching)
    version = 2

# ------------------------------------------------------------------------------
# Diff & Merge Tool (Delta)
# ------------------------------------------------------------------------------
[interactive]
    diffFilter = delta --color-only

[delta]
    navigate = true
    light = false
    side-by-side = true
    line-numbers = true
    syntax-theme = Dracula
    plus-style = "syntax #012800"
    minus-style = "syntax #340001"

[merge]
    conflictstyle = zdiff3

[diff]
    colorMoved = default

# ------------------------------------------------------------------------------
# Workflow Defaults
# ------------------------------------------------------------------------------
[init]
    defaultBranch = main

[pull]
    rebase = true

[push]
    autoSetupRemote = true
    default = simple

# ------------------------------------------------------------------------------
# Commit Signing (SSH)
# ------------------------------------------------------------------------------
# Architecture:
#   - Signing: YubiKey FIDO2 keys (main + backup)
#   - Format: SSH keys instead of GPG (simpler, works with agent forwarding)
#   - Verification: ~/.ssh/allowed_signers (both keys registered for validation)
#
# Key Switching:
#   1. Comment out the active signingkey line below
#   2. Uncomment the backup signingkey line
#   3. Run: chezmoi apply
#
# Verification Setup:
#   - Both keys are pre-registered in ~/.ssh/allowed_signers
#   - Signatures from either key will validate successfully
#   - GitHub/GitLab: Add both public keys to your account settings
# ------------------------------------------------------------------------------
[user]
    # SSH signing key (YubiKey FIDO) - Defined in .chezmoi.toml.tmpl
    # Using literal key format to support remote signing via agent forwarding

    # Main YubiKey (primary - currently active)
    signingkey = {{ .signingkey }}

    # Backup YubiKey (uncomment to switch, comment above line)
    # signingkey = {{ .backupsigningkey }}

[commit]
    # Sign all commits automatically
    gpgsign = true
    # Show full commit message in editor (helps catch errors before committing)
    verbose = true

[tag]
    # Sign all tags automatically
    gpgsign = true

[gpg]
    # Use SSH keys instead of GPG for signing
    format = ssh

[gpg "ssh"]
    # Use ssh-keygen for signing operations
    program = /usr/bin/ssh-keygen
    # File containing trusted signing keys (email -> public key mapping)
    # Both main and backup YubiKey public keys are registered here
    allowedSignersFile = ~/.ssh/allowed_signers
    # Optional: Revoked keys file (uncomment if needed)
    # revokedKeysFile = ~/.ssh/revoked_keys

