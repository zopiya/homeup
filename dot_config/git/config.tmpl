{{- /* ==============================================================================
Git Configuration - Profile-Aware

Profile Matrix:
  - workstation: Full config with GPG signing
  - codespace:   Full config, GPG signing DISABLED
  - server:      Full config, GPG signing DISABLED
============================================================================== */ -}}
{{- $profile := .profile | default "workstation" -}}
{{- $isWorkstation := eq $profile "workstation" -}}

# ==============================================================================
# Git Configuration
# Profile: {{ $profile }} | OS: {{ .chezmoi.os }}
# ==============================================================================

[include]
    # Load identity and aliases from separate files
    path = ~/.config/git/identity.gitconfig
    path = ~/.config/git/aliases.gitconfig

# ------------------------------------------------------------------------------
# Core Settings
# ------------------------------------------------------------------------------
[core]
    editor = nvim
    pager = delta

    # Line Endings: Convert CRLF to LF on commit, keep LF on checkout
    autocrlf = input
    safecrlf = true
    eol = lf

{{- if eq .chezmoi.os "darwin" }}
    # macOS Specific: Handle filename normalization (NFC vs NFD)
    precomposeunicode = true
    ignorecase = true
{{- end }}

# ------------------------------------------------------------------------------
# Network & Credentials
# ------------------------------------------------------------------------------
[credential]
{{- if eq .chezmoi.os "darwin" }}
    helper = osxkeychain
{{- else if eq $profile "codespace" }}
    # Codespace: Short cache for ephemeral environment
    helper = cache --timeout=3600
{{- else if eq $profile "server" }}
    # Server: Minimal cache
    helper = cache --timeout=900
{{- else }}
    # Workstation Linux: 24-hour cache
    helper = cache --timeout=86400
{{- end }}

[protocol]
    # Use Git wire protocol v2 (faster fetching)
    version = 2

# Force SSH for GitHub/GitLab to use your optimized ~/.ssh/config
[url "git@github.com:"]
    insteadOf = https://github.com/
[url "git@gitlab.com:"]
    insteadOf = https://gitlab.com/

# ------------------------------------------------------------------------------
# Diff & Merge Tool (Delta)
# ------------------------------------------------------------------------------
[interactive]
    diffFilter = delta --color-only

[delta]
    navigate = true
    light = false
    side-by-side = true
    line-numbers = true
    syntax-theme = Dracula
    plus-style = "syntax #012800"
    minus-style = "syntax #340001"

[merge]
    conflictstyle = zdiff3

[diff]
    colorMoved = default

# ------------------------------------------------------------------------------
# Workflow Defaults
# ------------------------------------------------------------------------------
[init]
    defaultBranch = main

[pull]
    rebase = true

[push]
    autoSetupRemote = true
    default = simple

# ------------------------------------------------------------------------------
# Commit Signing
# ------------------------------------------------------------------------------
[commit]
{{- if $isWorkstation }}
    gpgsign = true
{{- else }}
    # {{ $profile | title }}: GPG signing disabled
    # To enable manually: git config --global commit.gpgsign true
    gpgsign = false
{{- end }}
    verbose = true

[tag]
{{- if $isWorkstation }}
    gpgsign = true
{{- else }}
    gpgsign = false
{{- end }}

{{- if $isWorkstation }}

[gpg]
    format = openpgp
{{-   if eq .chezmoi.os "darwin" }}
{{-     if eq .chezmoi.arch "arm64" }}
    program = /opt/homebrew/bin/gpg
{{-     else }}
    program = /usr/local/bin/gpg
{{-     end }}
{{-   else }}
    program = gpg
{{-   end }}
{{- end }}

# --- FUTURE: SSH SIGNING ---
# [gpg]
#     format = ssh
# [gpg "ssh"]
#     program = ssh-keygen
#     allowedSignersFile = ~/.ssh/allowed_signers
