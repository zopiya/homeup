{{- /* ------------------------------------------------------------------ */ -}}
{{- /* üëã Welcome to homeup Setup - Interactive Configuration              */ -}}
{{- /* Priority: Environment variables > User prompts (for CI/automation) */ -}}
{{- /* ------------------------------------------------------------------ */ -}}

{{- writeToStdout "üëã Welcome to homeup Setup\n\n" -}}

{{- /* 1. Identity Configuration */ -}}
{{- writeToStdout "1. Identity Configuration\n" -}}
{{- $git_name := env "CHEZMOI_GIT_NAME" -}}
{{- if not $git_name -}}
    {{- $git_name = promptString "   Git Name" -}}
{{- end -}}
{{- $git_email := env "CHEZMOI_GIT_EMAIL" -}}
{{- if not $git_email -}}
    {{- $git_email = promptString "   Git Email" -}}
{{- end -}}

{{- /* 2. Machine Profile Selection */ -}}
{{- writeToStdout "\n2. Machine Profile\n" -}}
{{- writeToStdout "   [1] workstation  (macOS/Linux GUI) - Core + GUI + Fonts + Runtime + Maint\n" -}}
{{- writeToStdout "   [2] server       (Headless)        - Core + Runtime + Maint\n" -}}
{{- writeToStdout "   [9] manual       (Custom)          - Custom selection\n" -}}

{{- $profile_env := env "CHEZMOI_PROFILE" -}}
{{- $profile := 1 -}}
{{- if $profile_env -}}
    {{- $profile = $profile_env | atoi -}}
{{- else -}}
    {{- $profile = promptInt "   Select Profile" 1 -}}
{{- end -}}

{{- /* Default Variables */ -}}
{{- $install_gui := false -}}
{{- $install_fonts := false -}}
{{- $install_mise := false -}}
{{- $install_maintenance := false -}}
{{- $profile_name := "manual" -}}

{{- /* Logic based on Profile */ -}}
{{- if eq $profile 1 -}}
    {{- /* Workstation: All enabled */ -}}
    {{- $install_gui = true -}}
    {{- $install_fonts = true -}}
    {{- $install_mise = true -}}
    {{- $install_maintenance = true -}}
    {{- $profile_name = "workstation" -}}
{{- else if eq $profile 2 -}}
    {{- /* Server: No GUI */ -}}
    {{- $install_gui = false -}}
    {{- $install_mise = true -}}
    {{- $install_maintenance = true -}}
    {{- $profile_name = "server" -}}
{{- else -}}
    {{- /* Manual Mode */ -}}
    {{- writeToStdout "\n   Manual Configuration Mode:\n" -}}
    {{- $install_gui = promptBool "   Install GUI applications? (VSCode, Browser)" false -}}
    {{- $install_fonts = promptBool "   Install Fonts? (Nerd Fonts)" false -}}
    {{- $install_mise = promptBool "   Install Mise? (Runtime Manager)" true -}}
    {{- $install_maintenance = promptBool "   Install Maintenance tools? (Topgrade, Restic)" false -}}
    {{- $profile_name = "manual" -}}
{{- end -}}

{{- /* 3. Security Module (Independent Check) */ -}}
{{- writeToStdout "\n3. Security Module\n" -}}
{{- $install_security_env := env "CHEZMOI_INSTALL_SECURITY" -}}
{{- $install_security := false -}}
{{- if $install_security_env -}}
    {{- $install_security = eq $install_security_env "true" -}}
{{- else -}}
    {{- $install_security = promptBool "   Install Security tools? (YubiKey/GPG/1Password)" false -}}
{{- end -}}

{{- $git_signingkey := "" -}}
{{- if $install_security -}}
    {{- $git_signingkey = env "CHEZMOI_GIT_SIGNINGKEY" -}}
    {{- if not $git_signingkey -}}
        {{- $git_signingkey = promptString "   Git Signing Key (optional, press Enter to skip)" -}}
    {{- end -}}
{{- end -}}

{{- /* 4. Confirmation Summary */ -}}
{{- writeToStdout "\nüìù Configuration Summary:\n" -}}
{{- writeToStdout (printf "   Git User:    %s <%s>\n" $git_name $git_email) -}}
{{- writeToStdout (printf "   Profile:     %s\n" $profile_name) -}}
{{- writeToStdout "   Modules:\n" -}}
{{- writeToStdout "     [x] Core CLI (Base)\n" -}}
{{- writeToStdout (printf "     [%s] GUI Applications\n" (ternary "x" " " $install_gui)) -}}
{{- writeToStdout (printf "     [%s] Fonts\n" (ternary "x" " " $install_fonts)) -}}
{{- writeToStdout (printf "     [%s] Mise Runtime\n" (ternary "x" " " $install_mise)) -}}
{{- writeToStdout (printf "     [%s] Maintenance Tools\n" (ternary "x" " " $install_maintenance)) -}}
{{- writeToStdout (printf "     [%s] Security Suite\n" (ternary "x" " " $install_security)) -}}
{{- writeToStdout "\nüöÄ Configuration generated. Run 'chezmoi apply' to install dotfiles.\n\n" -}}

[data]
    name = {{ $git_name | quote }}
    email = {{ $git_email | quote }}
    
    # Feature Flags
    install_core_cli = true
    install_fonts = {{ $install_fonts }}
    install_gui = {{ $install_gui }}
    install_mise = {{ $install_mise }}
    install_maintenance = {{ $install_maintenance }}
    install_security = {{ $install_security }}
    git_signingkey = {{ $git_signingkey | quote }}

    # System Detection (Helper for templates)
    headless = {{ not $install_gui }}
    is_mac = {{ eq .chezmoi.os "darwin" }}
    is_linux = {{ eq .chezmoi.os "linux" }}
    is_wsl = {{ (and (eq .chezmoi.os "linux") (contains "microsoft" .chezmoi.kernel.osrelease)) }}

[update]
    apply = false
    method = "brew"

[diff]
    command = "delta"
    pager = "delta"

[merge]
    command = "nvim"
    args = ["-d", "{{ `{{ .Destination }}` }}", "{{ `{{ .Source }}` }}", "{{ `{{ .Target }}` }}"]
