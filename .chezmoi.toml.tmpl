# ==============================================================================
# Chezmoi Configuration
# ==============================================================================
# This file defines global variables available to all dotfile templates.
# Chezmoi processes .tmpl files and substitutes template variables with values below.

# --- Source Directory ---
# Ensure subsequent chezmoi/just commands read from the initialized source directory.
sourceDir = "{{ .chezmoi.sourceDir }}"

# ==============================================================================
# Profile Auto-Detection
# ==============================================================================
# Profile determines which dotfiles to deploy and how tools are configured.
#
# Profiles:
#   - macos: Trust anchor workstation with local YubiKey, full toolset, GUI apps
#   - linux: Remote servers, containers, Codespaces - relies on SSH agent forwarding
#
# Detection Logic:
#   1. Check HOMEUP_PROFILE environment variable (for CI/testing override)
#   2. Auto-detect based on OS: darwin -> macos, otherwise -> linux
#   3. Validate and fallback to linux if invalid
#
{{- $osProfile := eq .chezmoi.os "darwin" | ternary "macos" "linux" -}}
{{- $envProfile := env "HOMEUP_PROFILE" -}}
{{- $profile := $envProfile | default $osProfile -}}
{{- $validProfiles := list "macos" "linux" -}}
{{- if not (has $profile $validProfiles) -}}
{{-   $profile = "linux" -}}
{{- end }}

# ==============================================================================
# Global Variables
# ==============================================================================
[data]
    # --- Profile & System Info ---
    profile = "{{ $profile }}"
    os = "{{ .chezmoi.os }}"
    arch = "{{ .chezmoi.arch }}"
    hostname = "{{ .chezmoi.hostname }}"

    # --- Capability Flags (derived from profile) ---
    has_gui = {{ eq $profile "macos" }}
    has_private_key = {{ eq $profile "macos" }}
    has_gpg = {{ eq $profile "macos" }}
    has_agent_forward = true

    # --- User Identity ---
    name = "Zopiya"
    email = "i@zopiya.com"

    # Main YubiKey
    signingkey = "~/.ssh/main-ssh.zopiya.com"

    # Backup YubiKey
    backupsigningkey = "~/.ssh/back-ssh.zopiya.com"

    # Default SSH login user
    ssh_default_user = "zopiya"

    # --- SSH Public Keys for Git Signing ---
    signingkey_pub = "key::sk-ssh-ed25519@openssh.com AAAAGnNrLXNzaC1lZDI1NTE5QG9wZW5zc2guY29tAAAAIGctlOG1aZMZJi5NKHALQArMupDYKxiYudxWUhbJiW3xAAAAF3NzaDptYWluLXNzaC56b3BpeWEuY29t main-ssh.zopiya.com"
    backupsigningkey_pub = "key::sk-ssh-ed25519@openssh.com AAAAGnNrLXNzaC1lZDI1NTE5QG9wZW5zc2guY29tAAAAIGIsrImiTnp+s3cwf9Jj5sruHq2C8xSgfWNO9qMDAcRaAAAAF3NzaDpiYWNrLXNzaC56b3BpeWEuY29t back-ssh.zopiya.com"

    # --- SSH Login Public Keys ---
    ssh_authkey_main_pub = "sk-ssh-ed25519@openssh.com AAAAGnNrLXNzaC1lZDI1NTE5QG9wZW5zc2guY29tAAAAIGctlOG1aZMZJi5NKHALQArMupDYKxiYudxWUhbJiW3xAAAAF3NzaDptYWluLXNzaC56b3BpeWEuY29t main-ssh.zopiya.com"
    ssh_authkey_backup_pub = "sk-ssh-ed25519@openssh.com AAAAGnNrLXNzaC1lZDI1NTE5QG9wZW5zc2guY29tAAAAIGIsrImiTnp+s3cwf9Jj5sruHq2C8xSgfWNO9qMDAcRaAAAAF3NzaDpiYWNrLXNzaC56b3BpeWEuY29t back-ssh.zopiya.com"

# --- Editor ---
[edit]
    command = "nvim"

# --- Diff ---
[diff]
    command = "delta"
    pager = "delta"
    # exclude = ["scripts/**", "externals/**"]

# --- Merge ---
[merge]
    command = "nvim"
    args = ["-d", "{{ `{{ .Destination }}` }}", "{{ `{{ .Source }}` }}", "{{ `{{ .Target }}` }}"]

# --- Update ---
[update]
    apply = false
    method = "brew"
