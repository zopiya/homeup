# 安全审计清单 (Security Audit Checklist)

> Homeup 项目和个人开发环境的完整安全检查清单。定期使用以确保安全性。

**版本**: 2.1
**目标受众**: 开发者、系统管理员、安全团队
**前置知识**: 基本的安全概念、Homeup 基础

---

## 目录

- [快速安全检查](#快速安全检查)
- [密钥和认证](#密钥和认证)
- [配置和敏感信息](#配置和敏感信息)
- [网络和通信](#网络和通信)
- [包管理和依赖](#包管理和依赖)
- [访问控制](#访问控制)
- [备份和恢复](#备份和恢复)
- [定期审计计划](#定期审计计划)

---

## 快速安全检查

### 一键安全检查脚本

```bash
#!/bin/bash
# 保存为 security-check.sh，运行：bash security-check.sh

echo "🔐 Homeup Security Audit"
echo "========================"

PASS_COUNT=0
FAIL_COUNT=0

check() {
  if eval "$1"; then
    echo "✅ $2"
    ((PASS_COUNT++))
  else
    echo "❌ $2"
    ((FAIL_COUNT++))
  fi
}

# 密钥安全
echo ""
echo "### SSH Keys ###"
check "[ -f ~/.ssh/main ] || [ -f ~/.ssh/id_ed25519 ]" "SSH密钥存在"
check "[ $(stat -f%A ~/.ssh 2>/dev/null || stat -c%a ~/.ssh) = '700' ]" "SSH目录权限正确 (700)"

# Git 签名
echo ""
echo "### Git Signing ###"
check "git config user.signingkey | grep -q ." "Git签名密钥已配置"

# 敏感信息
echo ""
echo "### Sensitive Data ###"
check "! grep -r 'password' ~/.zshrc ~/.config/git/ 2>/dev/null | grep -v '#'" "没有密码在配置中"
check "! find . -name '.env' -not -path './.git/*' 2>/dev/null | grep -q '.env'" ".env 文件未跟踪"

# 防火墙
echo ""
echo "### Firewall ###"
if [ "$(uname)" = "Darwin" ]; then
  check "defaults read /Library/Preferences/com.apple.alf.plist globalstate 2>/dev/null | grep -q 1" "防火墙已启用"
fi

echo ""
echo "========================"
echo "结果: $PASS_COUNT 通过，$FAIL_COUNT 失败"
```

---

## 密钥和认证

### SSH 密钥安全检查

- [ ] **SSH 密钥存在**
  ```bash
  ls -la ~/.ssh/main
  ls -la ~/.ssh/main.pub
  ```

- [ ] **SSH 密钥权限正确**
  ```bash
  stat ~/.ssh/main      # 应该是 600 (-rw-------)
  stat ~/.ssh/          # 应该是 700 (drwx------)
  ```

- [ ] **私钥安全**
  ```bash
  # ✅ 私钥不应该包含在 Git 中
  git ls-files ~/.ssh/main | wc -l  # 应该是 0

  # ✅ 私钥不应该被复制或共享
  # 检查历史记录中是否有泄露
  git log --all --oneline --source --remotes -- ~/.ssh/
  ```

- [ ] **公钥在 GitHub 上**
  ```bash
  # 查看您的公钥
  cat ~/.ssh/main.pub

  # 访问 GitHub Settings → SSH Keys 验证
  # https://github.com/settings/keys
  ```

### YubiKey 安全检查

- [ ] **YubiKey 被识别**
  ```bash
  yk  # 应该成功初始化
  ssh-add -L | grep -i "sk-"  # 应该显示 YubiKey 密钥
  ```

- [ ] **备用 YubiKey 存在**
  ```bash
  # 应该有两个 YubiKey（主和备）
  # 检查：
  ssh-keygen -l -f ~/.ssh/main.pub
  ```

- [ ] **YubiKey PIN 已设置**
  ```bash
  # YubiKey 应该要求 PIN（不应该为空）
  # 验证：尝试 yk，如果成功应该要求 PIN
  ```

### Git 签名安全检查

- [ ] **提交签名已启用**
  ```bash
  git config user.signingkey          # 应该显示密钥路径
  git config commit.gpgsign           # 应该是 true
  git config gpg.format               # 应该是 ssh
  ```

- [ ] **签名密钥正确**
  ```bash
  # 验证最近的提交是否已签名
  git log --oneline --show-signature -3

  # 应该显示 "Good signature"
  ```

- [ ] **allowed_signers 配置正确**
  ```bash
  cat ~/.ssh/allowed_signers
  # 应该列出您的公钥和邮箱
  ```

---

## 配置和敏感信息

### .env 和本地配置

- [ ] **敏感文件在 .gitignore**
  ```bash
  grep -E "\.env|\.env\.local|\.secrets|credentials" .gitignore

  # 应该包含：
  # .env
  # .env.local
  # .env.*.local
  # .secrets
  ```

- [ ] **没有密钥在版本控制中**
  ```bash
  # 检查 Git 历史
  git log --all --full-history -p -- "*.env" | head -20

  # 应该为空或只显示示例文件
  ```

- [ ] **敏感信息未在配置文件中**
  ```bash
  # 检查配置文件中的密钥或密码
  grep -ri "password\|secret\|api.key\|token" ~/.config/ --exclude-dir=.git

  # 应该返回空或只有注释
  ```

- [ ] **本地覆盖文件存在**
  ```bash
  # 对于敏感配置，使用 .local 文件
  ls -la ~/.config/*/local  # 应该存在 .local 文件
  ls -la .env.local         # 项目根目录应该有
  ```

### Chezmoi 模板安全

- [ ] **模板中没有硬编码敏感信息**
  ```bash
  grep -r "password\|token\|secret" ~/.local/share/chezmoi/ --exclude-dir=.git

  # 应该为空或只有示例
  ```

- [ ] **.chezmoi.toml.tmpl 已正确模板化**
  ```bash
  # 敏感值应该使用 {{ .variable }}
  # 验证：
  grep "user_email\|api_key\|token" ~/.chezmoi.toml.tmpl

  # 应该看到模板变量，不是硬编码值
  ```

---

## 网络和通信

### SSH 配置安全性

- [ ] **SSH 配置使用强加密**
  ```bash
  cat ~/.ssh/config | grep -E "^Host|Cipher|HostKeyAlgorithm"

  # 应该使用：
  # - Ciphers: chacha20-poly1305, aes-256-gcm
  # - HostKeyAlgorithm: ssh-ed25519
  # - KeyExchange: curve25519-sha256
  ```

- [ ] **SSH 密钥类型强**
  ```bash
  ssh-keygen -l -f ~/.ssh/main.pub

  # 应该显示 ed25519（256位）
  # ❌ 不应该是 RSA-2048 或更弱
  ```

- [ ] **SSH 连接验证**
  ```bash
  ssh -T git@github.com

  # 应该显示：
  # Hi username! You've successfully authenticated...
  ```

### 网络通信

- [ ] **HTTPS 被强制**
  ```bash
  git remote -v | grep "http://"

  # 应该返回空（不应该有 http://）
  # 所有远程应该是 https:// 或 git@
  ```

- [ ] **VPN/代理配置安全**
  ```bash
  echo $http_proxy
  echo $https_proxy
  echo $all_proxy

  # 如果使用代理，应该是受信任的公司代理
  # 不应该从 .zshrc 硬编码
  ```

---

## 包管理和依赖

### Homebrew 安全

- [ ] **Homebrew 已更新**
  ```bash
  brew update
  brew outdated

  # 检查是否有过期的包
  ```

- [ ] **没有悬挂的包**
  ```bash
  brew leaves         # 列出叶子包（不依赖其他）

  # 移除不需要的：
  brew uninstall package
  ```

- [ ] **Brewfile 验证**
  ```bash
  just validate-brewfile

  # 应该通过
  ```

- [ ] **安全审计**
  ```bash
  # 检查已知漏洞
  brew audit

  # 检查过期的包
  brew outdated
  ```

### NPM/Yarn 安全（如适用）

- [ ] **npm audit 通过**
  ```bash
  npm audit

  # 应该没有 vulnerabilities（如有应该修复）
  ```

- [ ] **package-lock.json 被跟踪**
  ```bash
  git ls-files package-lock.json

  # 应该返回文件路径（确保可重现性）
  ```

- [ ] **node_modules 不在 Git 中**
  ```bash
  git ls-files | grep "node_modules" | head -5

  # 应该返回空
  ```

---

## 访问控制

### 文件权限检查

- [ ] **配置目录权限**
  ```bash
  # ~/.config 应该是 700
  stat ~/.config | grep Access

  # ~/.ssh 应该是 700
  stat ~/.ssh | grep Access

  # ~/.ssh/main 应该是 600
  stat ~/.ssh/main | grep Access
  ```

- [ ] **敏感文件权限**
  ```bash
  # .env.local 应该是 600
  [ -f .env.local ] && stat .env.local | grep Access

  # authorized_keys 应该是 600
  stat ~/.ssh/authorized_keys 2>/dev/null | grep Access
  ```

### 系统访问控制

- [ ] **防火墙启用**
  ```bash
  # macOS
  defaults read /Library/Preferences/com.apple.alf.plist globalstate

  # Linux
  sudo ufw status

  # 应该是启用
  ```

- [ ] **sudo 权限检查**
  ```bash
  sudo -l

  # 应该只显示必要的命令
  # 不应该有 NOPASSWD ALL
  ```

- [ ] **登录权限限制**
  ```bash
  # 检查是否只有授权用户可以登录
  cat /etc/ssh/sshd_config 2>/dev/null | grep -E "^AllowUsers|^DenyUsers"
  ```

---

## 备份和恢复

### 备份安全

- [ ] **备份被加密**
  ```bash
  # 如果有备份文件，应该被加密
  # 或存储在加密的磁盘上
  ls -la ~/backups/     # 检查权限
  file ~/backups/*.tar.gz  # 检查是否被加密
  ```

- [ ] **SSH 公钥已备份（但不是私钥）**
  ```bash
  # 备份 ~/.ssh/*.pub
  # ✅ 不要备份 ~/.ssh/main (私钥)

  # 验证备份不包含私钥
  grep "PRIVATE KEY" ~/backups/ssh_backup.tar.gz
  # 应该返回空
  ```

- [ ] **恢复测试**
  ```bash
  # 定期测试恢复流程
  # 在新机器上验证恢复完整性
  ```

### 灾难恢复计划

- [ ] **恢复步骤已记录**
  ```
  - [ ] YubiKey 恢复步骤
  - [ ] 新机器初始化步骤
  - [ ] SSH 密钥恢复步骤
  - [ ] Homeup 恢复步骤
  ```

- [ ] **紧急联系方式**
  ```
  - [ ] 公司 IT 联系方式
  - [ ] 安全团队联系方式
  - [ ] 应急流程文档
  ```

---

## 定期审计计划

### 每周检查（自动化）

```bash
#!/bin/bash
# 保存为 weekly-security-check.sh

echo "Weekly Security Check"
git log --oneline -7 | grep -i "security\|audit\|fix"
brew outdated
npm audit 2>/dev/null
```

### 每月检查（手动）

- [ ] **安全更新**
  ```bash
  # 检查是否有安全补丁
  brew update && brew outdated
  ```

- [ ] **依赖审计**
  ```bash
  # 检查已知漏洞
  npm audit
  pip list --outdated  # 如果使用 Python
  ```

- [ ] **访问权限审查**
  ```bash
  # 检查 GitHub 访问权限
  # https://github.com/settings/organizations

  # 检查本地权限
  stat ~/.ssh ~/.config/
  ```

- [ ] **备份验证**
  ```bash
  # 验证备份完整性
  ls -lh ~/backups/

  # 测试恢复（可选，但推荐）
  ```

### 季度检查（深度审计）

- [ ] **YubiKey 审计**
  ```bash
  yk
  ssh-add -L | grep -c "sk-"  # 应该 >= 1
  ```

- [ ] **Git 历史审计**
  ```bash
  # 检查是否有密钥被意外提交
  git log --all --full-history -p -- "*env*" | head -100
  git log --all --full-history -p -- "*.pem" | head -100
  ```

- [ ] **配置完整审计**
  ```bash
  # 运行完整安全检查脚本
  bash security-check.sh
  ```

- [ ] **系统更新**
  ```bash
  # 更新所有包
  brew upgrade

  # 更新系统
  softwareupdate -i -a  # macOS
  sudo apt update && sudo apt upgrade  # Linux
  ```

---

## 安全事件响应

### 如果发现泄露

1. **立即行动**
   ```bash
   # 如果发现私钥泄露
   ssh-keygen -p -f ~/.ssh/main  # 更改密钥短语
   # 或生成新密钥
   ssh-keygen -t ed25519-sk -C "new-key"
   ```

2. **更新 GitHub**
   ```
   - 删除旧的 SSH 密钥
   - 添加新的 SSH 密钥
   - 更新所有 Git 配置
   ```

3. **通知团队**
   ```
   - 告知安全团队
   - 更改所有相关密码
   - 更新访问权限
   ```

4. **审计日志**
   ```bash
   # 检查最近的 Git 活动
   git log --author="$USER" --since="2024-01-01"

   # 检查 SSH 连接日志
   log show --predicate "process='sshd'" | tail -100
   ```

### 如果发现漏洞

1. **评估严重性**
   ```
   - 是否影响关键系统？
   - 是否有已知的利用？
   - 是否有补丁可用？
   ```

2. **应急修复**
   ```bash
   # 安装补丁
   brew upgrade vulnerable-package

   # 或临时禁用
   brew uninstall vulnerable-package
   ```

3. **文档记录**
   ```
   - 漏洞时间和范围
   - 采取的措施
   - 未来预防措施
   ```

---

## 安全最佳实践总结

| 实践 | 频率 | 优先级 |
|------|------|--------|
| 运行 `security-check.sh` | 每周 | 🔴 关键 |
| 更新 Homebrew 包 | 每月 | 🟡 重要 |
| YubiKey 验证 | 每月 | 🟡 重要 |
| Git 历史审计 | 季度 | 🟢 可选 |
| 系统更新 | 按需 | 🔴 关键 |
| 备份测试 | 季度 | 🟡 重要 |

---

## 速查清单（打印版本）

```
每周：
- [ ] 运行安全检查脚本
- [ ] 检查 Brew 更新

每月：
- [ ] 审计依赖漏洞
- [ ] 检查 GitHub 访问权限
- [ ] 验证 YubiKey

季度：
- [ ] 深度安全审计
- [ ] 备份完整性测试
- [ ] Git 历史审计
```

---

## 相关文档

- [CONTRIBUTING.md](../CONTRIBUTING.md) - 贡献和代码规范
- [04_Git_SSH签名完整指南.md](04_Git_SSH签名完整指南.md) - SSH 和签名详解
- [31_YubiKey_FIDO2安全指南.md](31_YubiKey_FIDO2安全指南.md) - YubiKey 详细指南
- [51_故障排查与常见问题.md](51_故障排查与常见问题.md) - 常见问题解决

---

## 法律和合规性

- 定期审计有助于保持安全符合标准
- 记录审计过程以备将来审查
- 遵循公司和行业安全政策

---

**版本**: 2.1 | **最后更新**: 2024-01-16

⚠️ **提醒**: 安全是一个持续的过程。定期审计和更新是必要的。
