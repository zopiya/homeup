{{- /* ==============================================================================
SSH Configuration - Multi-Profile Support

Profile Matrix:
  - workstation: Trust anchor, local keys + CA cert, agent forwarding to remotes
  - codespace:   Borrowed trust, agent forwarded FROM host, no local keys
  - server:      Zero trust, no keys, no forwarding (CA auth handled server-side)

CA Certificate Strategy:
  - SSH auto-discovers *-cert.pub next to private key
  - No need to specify CertificateFile explicitly
  - Principals in cert control which users can be assumed

============================================================================== */ -}}
{{- $profile := .profile | default "workstation" -}}
{{- $isWorkstation := eq $profile "workstation" -}}
{{- $isCodespace := eq $profile "codespace" -}}
{{- $isServer := eq $profile "server" -}}

# ==============================================================================
# SSH Configuration
# Profile: {{ $profile }} | OS: {{ .chezmoi.os }}
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. Local Extensions (highest priority)
# ------------------------------------------------------------------------------
# Include local overrides (e.g., temporary work hosts, test environments)
Include ~/.ssh/config.local

# ------------------------------------------------------------------------------
# 2. Git Services (override User before Host *)
# ------------------------------------------------------------------------------
Host github.com gitlab.com bitbucket.org
    User git
    ServerAliveInterval 30
{{- if $isWorkstation }}
    # Prefer ed25519 key for git operations
    IdentityFile ~/.ssh/id_ed25519
{{- end }}

{{- if $isWorkstation }}

# ------------------------------------------------------------------------------
# 3. Host-Specific Overrides (Workstation only)
# ------------------------------------------------------------------------------
# Production servers: use deploy user
# Host prod-* staging-*
#     User deploy
#     ForwardAgent no

# Bastion / Jump hosts
# Host bastion jump
#     User zopiya
#     ForwardAgent yes
#     # ProxyJump none
{{- end }}

# ------------------------------------------------------------------------------
# 4. Global Defaults
# ------------------------------------------------------------------------------
Host *
{{- if $isWorkstation }}
    # === WORKSTATION PROFILE ===
    # Trust anchor: local YubiKey + CA-signed certificate

    # Default user (most common login identity)
    # CA cert principals control which users you can actually assume
    User zopiya

    # Identity (SSH auto-discovers id_ed25519-cert.pub)
    IdentityFile ~/.ssh/id_ed25519
    # IdentityFile ~/.ssh/id_ed25519_sk  # Uncomment for YubiKey FIDO

    # Forward agent cautiously; prompt per-connection by default
    ForwardAgent ask
    AddKeysToAgent yes

{{- else if $isCodespace }}
    # === CODESPACE PROFILE ===
    # Borrowed trust: agent forwarded from host machine

    # Don't set default User - rely on command line or host-specific config
    # The host's agent provides authentication

    # Accept forwarded agent from host (already available)
    # Do NOT forward further to avoid agent chain attacks
    ForwardAgent no

{{- else if $isServer }}
    # === SERVER PROFILE ===
    # Zero trust: no local keys, no agent forwarding
    # SSH client config is minimal; auth happens via CA on sshd side

    # No default user - specify explicitly per connection
    # No agent forwarding - this machine has no keys to forward
    ForwardAgent no

{{- end }}
    # --- Connection KeepAlive ---
    ServerAliveInterval 60
    ServerAliveCountMax 30

    # --- Connection Multiplexing ---
    ControlMaster auto
    ControlPath ~/.ssh/ssh_mux_%C
{{- if $isWorkstation }}
    ControlPersist 4h
{{- else }}
    ControlPersist 1h
{{- end }}

    # --- Performance ---
    Compression yes

    # --- Security ---
    HashKnownHosts yes
    VisualHostKey no
    StrictHostKeyChecking ask

    # Optional host CA bundle (public). Place host CA pubkey at ~/.ssh/ssh_ca.pub
    # and add @cert-authority lines there; keeps known_hosts clean.
    UserKnownHostsFile ~/.ssh/known_hosts ~/.ssh/ssh_ca.pub

{{- if eq .chezmoi.os "darwin" }}
    # --- macOS Keychain Integration ---
    IgnoreUnknown UseKeychain
    UseKeychain yes
{{- end }}
