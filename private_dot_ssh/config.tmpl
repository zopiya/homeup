{{- /* SSH config: macos uses local YubiKey; linux uses forwarded agent. OpenSSH 8.2+ for FIDO2. */ -}}
{{- $profile := .profile | default "linux" -}}
{{- $isMacos := eq $profile "macos" -}}
{{- $sshUser := .ssh_default_user | default "zopiya" -}}
{{- $mainKey := .signingkey | default "~/.ssh/main-ssh.zopiya.com" -}}
{{- $backupKey := .backupsigningkey | default "~/.ssh/back-ssh.zopiya.com" -}}

# ==============================================================================
# SSH Configuration (Profile: {{ $profile }} | OS: {{ .chezmoi.os }})
# ==============================================================================
# Uses Homebrew OpenSSH (not macOS system SSH) for FIDO2/SK key support.
#
# YubiKey Usage:
#   - Load resident keys: yk (or ssh-add -K)
#   - List loaded keys: ssh-add -l
#   - Clear agent: ssh-add -D
# ==============================================================================


# 1. Local Extensions (optional ~/.ssh/config.local)
# OpenSSH skips if missing
Include ~/.ssh/config.local

# 2. Git Services (user git, no agent forwarding)
Host github.com gitlab.com bitbucket.org gitea.com
    User git
    ServerAliveInterval 30
    ForwardAgent no
    IdentitiesOnly yes

# 3. macOS host override first (higher priority than Host *)
{{- if $isMacos }}
Host *.hs
    ForwardAgent yes
{{- end }}

# 4. Global Defaults
Host *
{{- if $isMacos }}
    User {{ $sshUser }}
    IdentityFile {{ $mainKey }}
    IdentityFile {{ $backupKey }}
    ForwardAgent no
    # Auto-add keys to agent on first use (works with YubiKey)
    AddKeysToAgent yes
{{- else }}
    ForwardAgent no
{{- end }}
    ServerAliveInterval 60
    ServerAliveCountMax 30
    ControlMaster auto
    ControlPath ~/.ssh/cm-%C
{{- if $isMacos }}
    ControlPersist 4h
{{- else }}
    ControlPersist 1h
{{- end }}
    IdentitiesOnly yes
    Compression yes
    HashKnownHosts yes
    VisualHostKey no
    StrictHostKeyChecking ask
    KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512
    Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
    MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com
    UserKnownHostsFile ~/.ssh/known_hosts


