#!/bin/bash

# Purpose: Install and configure Mise (Runtime Manager)
# Runs once when hash changes

{{- template "utils.sh" . -}}

{{ if not .install_mise -}}
info "Skipping Mise configuration"
exit 0
{{ end -}}

set -euo pipefail

header "Configuring Mise Runtime Manager"

# Homebrew Configuration
if [[ -x /opt/homebrew/bin/brew ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -x /usr/local/bin/brew ]]; then
  eval "$(/usr/local/bin/brew shellenv)"
elif [[ -x /home/linuxbrew/.linuxbrew/bin/brew ]]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
elif [[ -x "$HOME/.linuxbrew/bin/brew" ]]; then
  eval "$("$HOME/.linuxbrew/bin/brew" shellenv)"
fi

# Install tools defined in config.toml
step 1 3 "Installing tools from config.toml..."
mise install > /dev/null 2>&1 &
spinner $! "Running mise install..."
success "Tools installed"

# Install global packages
step 2 3 "Installing global packages..."
mise use -g python@3.12 > /dev/null 2>&1 &
spinner $! "Installing Python 3.12..."

mise use -g node@lts > /dev/null 2>&1 &
spinner $! "Installing Node.js LTS..."
success "Global packages installed"

# Install uv and pnpm
step 3 3 "Installing package managers..."
mise exec python@3.12 -- pip install uv > /dev/null 2>&1 &
spinner $! "Installing uv..."

mise exec node@lts -- npm install -g pnpm > /dev/null 2>&1 &
spinner $! "Installing pnpm..."
success "Package managers installed"

echo ""
success "Mise configuration complete"
