#!/bin/bash

# Restic Backup Script
# Usage: ./restic_backup.sh

set -e

{{- template "utils.sh" . -}}

header "Restic Backup"

# Load environment variables (e.g. from 1Password or .env file)
# export RESTIC_REPOSITORY="..."
# export RESTIC_PASSWORD="..."
# export AWS_ACCESS_KEY_ID="..."
# export AWS_SECRET_ACCESS_KEY="..."

step 1 3 "Checking Restic..."
if ! command -v restic &> /dev/null; then
    error "Restic not installed."
    exit 1
else
    success "Restic found"
fi

step 2 3 "Starting backup..."
# Restic output is important, so we let it show
restic backup $HOME --exclude-file=.resticignore
success "Backup finished"

step 3 3 "Pruning old snapshots..."
restic forget --keep-daily 7 --keep-weekly 4 --keep-monthly 6 --prune
success "Pruning finished"

echo ""
success "Backup complete"
